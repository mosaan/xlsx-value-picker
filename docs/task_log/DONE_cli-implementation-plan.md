# CLIスケルトン実装計画

## 1. 概要

このドキュメントでは、xlsx-value-pickerのCLIインターフェーススケルトンの実装計画について説明します。現在の実装はargparseを使用していますが、技術選定ドキュメントで選定されているClickライブラリを使用してCLI仕様に準拠した実装を行います。

## 2. 実装アプローチ

### 2.1 実装方針

1. **Click対応**: argparseからClickへの移行
2. **スケルトン実装**: 各コマンド・オプションの基本構造を実装し、単純な動作確認用のprint文を出力
3. **段階的実装**: コマンド構造→オプション→基本機能→バリデーション機能の順で実装
4. **ヘルプメッセージの充実**: 各コマンド・オプションに適切な説明を付与

### 2.2 Click導入のメリット

- 宣言的で直感的なAPIによるコマンドライン引数の処理
- コマンドのネスト、グループ化のサポート
- 自動ヘルプテキスト生成によるユーザビリティの向上
- タイプヒントとの統合が良好

## 3. CLI構造の設計

### 3.1 基本コマンド構造

```
excel-validator [オプション] <入力ファイル>
```

### 3.2 オプション一覧

#### 入力オプション
- `-c`, `--config <設定ファイル>`: 検証ルールや設定を記述した設定ファイル（YAML形式）

#### 検証オプション
- `--ignore-errors`: 検証エラーが発生しても処理を継続

#### 出力オプション
- `-o`, `--output <出力ファイル>`: JSONデータの出力先ファイル
- `--log <ログファイル>`: 検証エラーを記録するログファイル
- `--format <フォーマット>`: 出力フォーマット（`json`, `yaml`）
- `--template <Jinja2テンプレートファイル>`: Jinja2テンプレートによる出力カスタマイズ

#### ヘルプとバージョン
- `-h`, `--help`: ヘルプ情報を表示（Clickにより自動提供）
- `-v`, `--version`: ツールのバージョンを表示

## 4. 実装ステップ

1. **環境準備**
   - Clickライブラリのインストール
   - 既存コードの確認と整理

2. **基本CLIスケルトンの実装**
   - `cli.py`の再構築（Click使用）
   - 基本コマンド構造の実装
   - 各オプションの定義

3. **動作確認用の簡易出力実装**
   - 各コマンド・オプションごとに単純なprint文で動作確認
   - 入力値の表示と簡単な処理フロー確認

4. **エラーハンドリングの基本実装**
   - ファイル存在チェック
   - オプション値の検証
   - エラーメッセージの出力

5. **テストケース作成**
   - 各コマンド・オプションの組み合わせテスト
   - エラーケースのテスト

## 5. 実装詳細

### 5.1 Click使用による主要コマンド実装

```python
# 基本コマンド実装イメージ
@click.command()
@click.argument('input_file', type=click.Path(exists=True, file_okay=True, dir_okay=False))
@click.option('-c', '--config', default='config.yaml', help='検証ルールや設定を記述した設定ファイル')
@click.option('--ignore-errors', is_flag=True, help='検証エラーが発生しても処理を継続します')
@click.option('-o', '--output', help='JSONデータの出力先ファイルを指定します')
@click.option('--log', help='検証エラーを記録するログファイルを指定します')
@click.option('--format', type=click.Choice(['json', 'yaml']), default='json', help='出力フォーマットを指定します')
@click.option('--template', help='Jinja2テンプレートを使用して出力をカスタマイズします')
@click.version_option(version='0.1.0')
def main(input_file, config, ignore_errors, output, log, format, template):
    """Excel検証およびJSON出力ツール"""
    click.echo(f"入力ファイル: {input_file}")
    click.echo(f"設定ファイル: {config}")
    click.echo(f"エラー無視: {ignore_errors}")
    click.echo(f"出力ファイル: {output}")
    click.echo(f"ログファイル: {log}")
    click.echo(f"フォーマット: {format}")
    click.echo(f"テンプレート: {template}")
    click.echo("Hello World")
```

### 5.2 コマンド実行フロー

1. コマンドライン引数のパース（Click）
2. 入力ファイルと設定ファイルの存在確認
3. 設定ファイルの読み込み
4. 入力オプションの処理
5. Excelファイルからの値取得
6. バリデーション処理
7. 出力オプションに基づく出力処理

## 6. 移行計画

### 6.1 既存機能の移行

現在の実装から以下の機能を順次移行します：

1. 設定ファイル読み込み機能
2. Excelファイルからの値取得機能
3. 出力形式（JSON/YAML）の処理
4. テンプレートレンダリング機能

### 6.2 新規機能の追加

Click対応と同時に以下の新機能を追加します：

1. バリデーション機能のスケルトン
2. エラーログ出力機能
3. エラー無視オプションの処理

## 7. 注意事項

- 既存の機能を段階的に移行し、各ステップで動作確認を行う
- ユーザーへの影響を最小限に抑えるため、既存のコマンドライン引数はできるだけ互換性を保つ
- ヘルプメッセージは日本語で提供し、ユーザーにとって分かりやすい表現を心がける
- バージョン管理を徹底し、各実装ステップでのコミットを明確にする

## 8. タイムライン

1. 基本CLIスケルトン実装: 1日
2. 動作確認用の簡易出力実装: 0.5日
3. エラーハンドリングの基本実装: 0.5日
4. テストケース作成: 1日
5. 既存機能の移行: 2日
6. 新規機能の追加: 3日

合計: 約8日間

## 9. 次のステップ

この計画に基づいて、まずはClick対応のCLIスケルトンを実装し、既存の機能を段階的に移行しながら、最終的にはバリデーション機能の実装を行っていきます。