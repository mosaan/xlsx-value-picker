# テストコードリファクタリング計画

## 1. 目的

`test/` ディレクトリ以下のテストコード全体を見直し、重複の排除、構成の改善、可読性の向上を図り、テストコードの品質とメンテナンス性を向上させます。

## 2. 背景

現在のテストコードには、特にバリデーション関連のテスト (`test/validation/`) などで、テストデータのセットアップやアサーション部分に重複が見られます。また、テストケースの粒度や構成にも改善の余地があり、より効率的で理解しやすいテストコードにリファクタリングする必要があります。

## 3. 作業計画 (検討事項含む)

1.  **現状分析:** `test/` ディレクトリ以下の全テストファイルを確認し、重複箇所、改善可能な構成、可読性の低い箇所を特定します。
2.  **リファクタリング方針検討:**
    *   **Fixture活用:** `pytest` の fixture を積極的に活用し、テストデータのセットアップや共通処理の重複を排除します。
    *   **Parametrization:** `pytest.mark.parametrize` を使用し、類似のテストケースをまとめて記述します。
    *   **ヘルパー関数/クラス:** テスト固有の複雑なロジックやアサーションをヘルパー関数やクラスに切り出します。
    *   **ファイル/ディレクトリ構成:** 必要に応じてテストファイルの分割や統合、ディレクトリ構成の見直しを行い、関連性の高いテストをまとめます。
    *   **命名規則:** テスト関数名や変数名が、テストの内容を明確に表すように見直します。
3.  **実装:** 決定した方針に基づき、テストコードを段階的にリファクタリングします。まずは重複排除の効果が高い箇所や、可読性向上が急務な箇所から着手します。
4.  **テスト実行:** リファクタリング対象のテストおよび関連するテストが、リファクタリング後もすべて成功することを確認します。`uv run test` を実行します。

## 4. 作業手順

1.  本計画書についてユーザーの承認を得ます。
2.  承認後、ファイル名を `WIP_refactor-test-code.md` に変更します。
3.  上記「3. 作業計画」に従ってリファクタリングを実施します。
4.  テストを実行し、すべてのテストが成功することを確認します。
5.  作業完了後、本計画書に結果を追記し、ファイル名を `DONE_refactor-test-code.md` に変更してユーザーに完了報告を行います。

## 5. 影響範囲

- `test/` ディレクトリ以下のテストファイル群

## 6. リスク

- リファクタリングによって、本来検出できていたはずのバグを見逃すようなテストになってしまう可能性。
    - 対策: リファクタリング前後でテストカバレッジが低下しないか確認します。重要なテストケースについては、変更内容を慎重にレビューします。
- Fixture や Parametrization の使い方を誤り、テストが意図通りに動作しなくなる可能性。
    - 対策: `pytest` のドキュメントを参照し、適切な使い方を確認します。

## 7. 承認

ユーザー確認待ち。

## 8. 作業結果 (2025-04-20追記)

- `test/validation/conftest.py` を作成し、共通の `validation_context` fixture を定義しました。
- `test/validation/` 配下の以下のテストファイルをリファクタリングし、共通 fixture と `pytest.mark.parametrize` を使用するように変更しました。
    - `test_all_of_expression.py`
    - `test_any_of_expression.py`
    - `test_compare_expression.py`
    - `test_enum_expression.py`
    - `test_not_expression.py`
    - `test_regex_match_expression.py`
    - `test_required_expression.py`
    - `test_rule.py`
- リファクタリング中に発見されたテストの失敗に基づき、`src/xlsx_value_picker/config_loader.py` の以下のクラスのバリデーションロジックを修正しました。
    - `AllOfExpression`: 失敗したサブ式の `error_fields` と `error_locations` を正しく収集するように修正。
    - `EnumExpression`: `None` 値や存在しないフィールドの場合の処理を修正し、`error_locations` を追加。
    - `RegexMatchExpression`: `None` 値や空文字列の場合の処理を修正し、`error_locations` を追加。
    - `CompareExpression`: `error_locations` を追加。
    - `Rule`: 失敗時に `error_locations` が正しく設定されるように修正。
- `uv run pytest` を実行し、すべてのテスト (127件) が成功することを確認しました。

## 9. 完了確認

上記作業結果に基づき、テストコードのリファクタリングは完了と判断します。ユーザーに完了を確認・承認を依頼します。