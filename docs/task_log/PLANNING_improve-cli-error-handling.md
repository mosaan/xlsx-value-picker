```markdown
# CLIエラーハンドリング改善計画

## 1. 目的

`cli.py` におけるエラーハンドリング処理、特に `--ignore-errors` オプションに関連するロジックを簡素化し、可読性と保守性を向上させます。

## 2. 背景

現状の `cli.py` では、設定読み込み、バリデーション、Excel処理、出力処理の各段階で `try...except` ブロックと `--ignore-errors` フラグのチェックがネストしており、コードの流れが複雑になっています。エラー発生時の処理フローを一貫性のあるシンプルな形に改善する必要があります。

## 3. 作業計画 (検討事項含む)

1.  **現状分析:** `cli.py` の `main` 関数内のエラーハンドリング箇所を詳細に分析し、複雑さの原因となっている箇所を特定します。
2.  **改善方針検討:** 以下のいずれか、または組み合わせによる改善方針を検討します。
    *   **エラーハンドリング用デコレータ:** エラー処理と `--ignore-errors` のチェックを共通化するデコレータを作成し、各処理関数に適用する。
    *   **共通エラー処理関数:** エラー発生時のログ出力や終了処理をまとめた共通関数を作成し、各 `except` ブロックから呼び出す。
    *   **コンテキストマネージャ:** リソース管理（Excelファイルなど）とエラーハンドリングを組み合わせたコンテキストマネージャを導入する。
    *   **例外クラスの整理:** プロジェクト固有の例外クラスを定義し、より詳細なエラーハンドリングを可能にする。
3.  **実装:** 決定した方針に基づき、`cli.py` のエラーハンドリング部分をリファクタリングします。
4.  **テスト:** `--ignore-errors` オプションの有無による動作の違いを含め、エラー発生時の挙動が期待通りであることを確認するテストケースを追加・修正します。
5.  **テスト実行:** `uv run test` を実行し、すべてのテストが成功することを確認します。

## 4. 作業手順

1.  本計画書についてユーザーの承認を得ます。
2.  承認後、ファイル名を `WIP_improve-cli-error-handling.md` に変更します。
3.  上記「3. 作業計画」に従ってリファクタリングを実施します。
4.  テストを実行し、すべてのテストが成功することを確認します。
5.  作業完了後、本計画書に結果を追記し、ファイル名を `DONE_improve-cli-error-handling.md` に変更してユーザーに完了報告を行います。

## 5. 影響範囲

- `src/xlsx_value_picker/cli.py`
- 関連するテストコード (`test/test_cli_integration.py` など)

## 6. リスク

- リファクタリングによるエラーハンドリングの意図しない変更（デグレード）。
    - 対策: エラー発生時のテストケースを拡充し、動作確認を徹底します。
- 改善方針の選定が不適切で、逆に複雑化してしまう可能性。
    - 対策: 実装前に改善方針のメリット・デメリットを十分に比較検討します。

## 7. 承認

ユーザー確認待ち。
```