# Pydanticモデル設計ガイドライン作成計画

## 1. 目的

プロジェクトにおけるPydanticモデルの設計方針、特にデータ構造定義とビジネスロジックの扱いに関するガイドラインを策定し、文書化する。これにより、今後の開発における設計判断の一貫性を保ち、コードの品質と保守性を向上させる。

## 2. 背景

Pydanticモデルはデータ構造の定義と検証に強力な機能を提供するが、そのモデルにビジネスロジック（メソッド）を含めるべきか、あるいはデータ構造定義に専念させるべきかは設計上のトレードオフが存在する。バリデーション機能の実装検討において、このトレードオフが顕在化したため、プロジェクト全体の方針を明確にする必要がある。

## 3. ガイドラインの内容案

以下の項目を含むガイドライン文書 (`docs/guide/pydantic-model-design-guideline.md`) を作成する。

1.  **はじめに**: ガイドラインの目的と対象読者。
2.  **Pydanticモデルの基本的な責務**:
    *   データ構造の定義。
    *   入力データの型検証と変換（パース）。
    *   外部データ形式（JSON, YAMLなど）との相互変換。
3.  **ビジネスロジックの扱いに関する方針**:
    *   **原則**: データ構造定義とビジネスロジックは分離する（SRP: 単一責任の原則）。ロジックはサービスクラスや関数などで実装する。
    *   **例外 (凝集度優先)**: データとそのデータを操作する手続き（振る舞い）が**密接不可分**であり、それらを一体として扱うことで**凝集度**が著しく向上し、オブジェクト指向の原則（カプセル化）にも合致する場合に限り、Pydanticモデルにビジネスロジック（メソッド）を持たせることを**許容**する。
4.  **適用例: バリデーションルールモデル**:
    *   バリデーション機能における `RuleModel` や `Expression` 派生モデルは、「ルール定義（データ）」と「そのルールに基づく検証（振る舞い）」が密接に関連している。
    *   これらを一体としてモデルに実装することで、凝集度が高まり、ファクトリによる変換も不要になるため、この方針を採用した具体例として説明する。
5.  **判断基準と考慮事項**:
    *   **凝集度**: データとロジックを一体と見なす自然さ、関連性の強さ。
    *   **責務の肥大化**: モデルの責務が過度に多くなり、複雑化しないか。
    *   **テスト容易性**: ロジックを含むモデルの単体テストが現実的に可能か。依存性の注入（DI）などを検討する。
    *   **再利用性**: ロジック部分をモデル外で再利用する必要があるか。
    *   **Pydanticの主目的**: ライブラリの意図から大きく逸脱していないか。
    *   **コードのシンプルさ**: ロジックを含めることで、全体としてコードがよりシンプルかつ直感的になるか？（例: ファクトリが不要になる）
6.  **結論**: 状況に応じてSRPと凝集度のバランスを考慮し、判断する。基本は分離を推奨するが、明確なメリットがある場合はロジックの同梱を許容する。

## 4. 作業ステップ

1.  ~~本計画書 (`WIP_pydantic-guideline-creation.md`) を作成し、ユーザーレビューを受ける。~~ **完了**
2.  ~~レビュー結果に基づき、ガイドライン文書 (`docs/guide/pydantic-model-design-guideline.md`) のドラフトを作成する。~~ **完了**
3.  ~~ガイドライン文書のドラフトについて、ユーザーレビューを受ける。~~ **完了**
4.  ~~レビュー結果を反映し、ガイドライン文書を完成させる。~~ **完了**
5.  本計画書のファイル名を `DONE_pydantic-guideline-creation.md` に変更し、成果物へのリンクなどを追記する。

## 5. 成果物

-   [docs/guide/pydantic-model-design-guideline.md](docs/guide/pydantic-model-design-guideline.md) (新規作成)
-   `docs/task_log/DONE_pydantic-guideline-creation.md` (本計画書を更新)

## 6. 作業結果

計画に基づき、Pydanticモデルの設計方針に関するガイドライン文書を作成し、ユーザーの承認を得た。
