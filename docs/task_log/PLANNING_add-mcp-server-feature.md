# MCPサーバー機能追加 計画 (PLANNING)

## 1. 目的

本ツールにModel Context Protocol (MCP) サーバーとしての機能を追加し、外部のMCPクライアント（例: VS Code拡張機能など）から本ツールの機能を利用できるようにする。これにより、ツールの利用シーン拡大と他の開発ツールとの連携強化を目指す。

特に、「Excelファイルの内容を適切に構造化したテキストとして生成AIに受け渡すことにより、既存Excelファイルの内容を正確に活用する」ことを主要な目的とし、生成AIを活用したワークフローの効率化を図る。

## 2. 背景

現在、本ツールはコマンドラインインターフェース (CLI) として提供されている。MCPサーバー機能を追加することで、GUIクライアントや他の自動化ツール、特に生成AI関連のツールからの利用が容易になり、開発・業務ワークフローへの統合が促進される。

## 3. 機能要件

### 3.1 技術選定要件

- **バックエンド方式**: MCPサーバーは**stdio（標準入出力）をバックエンド**としたもののみを対象とする。これは本プロジェクトが扱う対象がローカルリソースのみであり、SSE（Server Sent Event）をバックエンドとしたMCPサーバーは過剰であるためである。

### 3.2 コア機能要件

-   **サーバー起動**: 指定されたポートでMCPサーバーとして起動できる。
-   **設定連携**: 既存の設定ファイル (`config.yaml`) を読み込み、サーバーの動作に反映する。
-   **モデルリスト提供 (`$/listModels`)**: 設定ファイルに基づき、利用可能な「モデル」（Excelファイル処理設定に対応）のリストを提供する。
-   **モデル情報提供 (`$/getModelInfo`)**: 指定されたモデルに関する詳細情報（設定内容、対象ファイルなど）を提供する。
-   **バリデーション結果提供 (`$/getDiagnostics`)**: 設定ファイルや対象Excelファイルに対するバリデーション結果をMCPクライアントに通知する。
-   **ファイル内容の構造化テキスト提供 (`$/getFileContent`)**: 指定されたモデルに基づいて、Excelファイルの内容を構造化されたテキスト（JSON、YAML、Markdown等）として提供する。特に、バリデーションを通過したモデルによる出力のみを生成AIに提供することで、精度の高い情報活用を可能にする。
-   **既存機能活用**: 既存の `config_loader`, `excel_processor`, `validation` モジュールの機能を再利用する。
-   **エラーハンドリング**: MCP仕様に準拠したエラー通知を行う。
-   **ロギング**: サーバーの動作状況やエラー情報を記録する。

### 3.3 生成AI連携機能要件

- **生成AI向け最適化**: 出力フォーマットは生成AIが処理しやすい形式を提供する。構造化データとメタデータを明確に分離し、生成AIが理解しやすい形式とする。
- **バリデーション統合**: モデル選択の負担を軽減するため、バリデーションを通過したモデルによる出力のみを生成AIに提供する仕組みを実装する。これにより、ユーザーや生成AIが過剰にモデル選択を気にする必要を軽減する。
- **コンテキスト管理**: 生成AIとの会話コンテキストを維持するための情報を適切に管理・提供する機能を検討する。

## 4. 設計方針

-   **ライブラリ選定**: Pythonの標準的な非同期処理ライブラリ (`asyncio`) と、Language Server Protocol (LSP) 実装ライブラリである `pygls` を利用してMCPサーバーを構築する。`pygls` はLSPをベースとしているが、MCPのカスタムリクエスト/通知にも対応可能である。
-   **通信バックエンド**: stdio（標準入出力）をバックエンドとして利用し、簡素でロバストな実装を目指す。
-   **アーキテクチャ**:
    -   `src/xlsx_value_picker/mcp_server/` ディレクトリを新設し、サーバー関連のコードを格納する。
    -   `server.py`: サーバーの起動、`pygls` の初期化、リクエストハンドラーの登録を行う。
    -   `handlers.py`: 各MCPリクエスト (`$/listModels`, `$/getModelInfo` など) に対応するハンドラー関数を実装する。
    -   `protocol.py`: MCP固有のデータ構造（モデル情報など）をPydanticモデルで定義する。
-   **エントリーポイント**: CLIに `server` サブコマンドを追加し、`xlsx-value-picker server [--port <ポート番号>]` の形式でサーバーを起動できるようにする。
-   **モデル概念**: 設定ファイル内の各処理設定（特定のExcelファイルとそれに適用するルール群）をMCPにおける「モデル」として扱う。
-   **状態管理**: サーバーインスタンス内で、読み込んだ設定情報やモデルの状態を管理する。
-   **バリデーション連携**: 既存のバリデーション機能と連携し、バリデーション結果に基づいたモデル選択・出力生成の仕組みを構築する。

## 5. 実装タスク

1.  **依存関係追加**: `pyproject.toml` に `pygls` を追加し、`uv pip install pygls` を実行する。
2.  **ディレクトリ/ファイル作成**: `src/xlsx_value_picker/mcp_server/` ディレクトリと、その配下に `__init__.py`, `server.py`, `handlers.py`, `protocol.py` を作成する。
3.  **CLIサブコマンド追加**: `src/xlsx_value_picker/cli.py` を修正し、`server` サブコマンドと関連オプション（`--port` など）を追加する。
4.  **サーバー基盤実装 (`server.py`)**: `pygls` を用いて基本的なサーバープロセスを実装し、指定ポートでリスニングを開始する処理を記述する。標準入出力をバックエンドとして使用する設定を行う。
5.  **MCPプロトコル定義 (`protocol.py`)**: 
    - `$/listModels` や `$/getModelInfo` で使用するデータ構造をPydanticモデルで定義する。
    - 新たに追加する `$/getFileContent` 用のデータ構造も定義する。
6.  **ハンドラー実装 (`handlers.py`)**:
    -   `handle_list_models`: `config_loader` を利用して設定を読み込み、モデルリストを生成して返す。
    -   `handle_get_model_info`: 指定されたモデルIDに対応する設定情報を返す。
    -   `handle_get_diagnostics`: `validation` モジュールを利用してバリデーションを実行し、結果を返す。
    -   `handle_get_file_content`: 指定されたモデルに基づき、Excelファイルの内容を構造化テキストとして返す。バリデーション結果を考慮し、問題がある場合は適切なエラーを返す。
7.  **ハンドラー登録 (`server.py`)**: 実装したハンドラー関数を `pygls` のサーバーインスタンスに登録する。
8.  **ロギング設定**: Python標準の `logging` モジュールを設定し、サーバーの動作ログを出力するようにする。
9.  **テストコード作成**:
    -   `test/test_mcp_server.py` を作成し、各ハンドラーのユニットテストを実装する。モックを使用して依存コンポーネント（`config_loader` など）を分離する。
    -   （可能であれば）基本的なMCPクライアントとの結合テストを実装する。
10. **テスト実行**: `pytest` を実行し、新規追加分を含むすべてのテストが成功することを確認する。
11. **生成AI連携検証**: 主要な生成AIプラットフォームとの連携動作を検証し、必要に応じて出力形式を調整する。

## 6. 既存文書の改訂方針

以下のドキュメントについて、MCPサーバー機能の追加に伴う改訂を行う。

-   **`docs/README.md`**:
    -   「機能」セクションにMCPサーバー機能を追加。
    -   「使い方」セクションに `server` サブコマンドによる起動方法と基本的な利用例を追加。
-   **`docs/project-status.md`**:
    -   「MCPサーバー機能」の項目を追加し、進捗ステータスを管理する。
-   **`docs/design/`**:
    -   `mcp-server-design.md` を新規作成し、本計画の「4. 設計方針」および「5. 実装タスク」で検討した内容を基に、より詳細な設計（クラス図、シーケンス図、API詳細など）を記述する。
-   **`docs/project/requirements.md`**:
    -   MCPサーバー機能に関する要件（機能要件、非機能要件）を追記する。
-   **`docs/project/technology-selection.md`**:
    -   MCPサーバー実装のために `pygls` を採用した理由や、関連する技術要素について追記する。
-   **`docs/spec/cli-spec.md`**:
    -   `server` サブコマンドの仕様（引数、オプション、動作）を詳細に記述する。
-   **`docs/guide/directory-structure-guideline.md`**:
    -   `src/xlsx_value_picker/mcp_server/` ディレクトリ構造と各ファイルの役割について追記する。
-   **`docs/task_log/`**:
    -   本計画ファイル (`PLANNING_add-mcp-server-feature.md`) を配置する。

## 7. テスト方針

-   **ユニットテスト**: `pytest` と `unittest.mock` を使用し、各ハンドラー関数やサーバーのコアロジックを個別にテストする。既存モジュールへの依存はモックで代替する。
-   **結合テスト**: `pygls` が提供するテストユーティリティや、非同期テストフレームワーク (`pytest-asyncio`) を活用し、サーバープロセスを起動して実際にMCPリクエストを送信し、レスポンスを検証するテストを実装する。
-   **テストカバレッジ**: 新規コードに対するテストカバレッジを計測し、十分な網羅率を目指す。
-   **CI連携**: CIパイプラインで全てのテストが自動実行されるように設定する。

## 8. 成果物

-   MCPサーバー機能の実装コード (`src/xlsx_value_picker/mcp_server/` 以下)
-   MCPサーバー機能のテストコード (`test/test_mcp_server.py` など)
-   改訂された各種ドキュメント (`docs/` 配下)
-   更新された `pyproject.toml` および `uv.lock`
-   本計画書 (`docs/task_log/PLANNING_add-mcp-server-feature.md`)

## 9. リスクと課題

-   **`pygls` と非同期処理**: `pygls` および `asyncio` の習熟度によっては、実装やデバッグに時間を要する可能性がある。
-   **既存コードとの連携**: 同期的な既存コード (例: `openpyxl` を利用する箇所) と非同期サーバーとの連携方法を適切に設計する必要がある (例: `asyncio.to_thread`)。
-   **MCP仕様の解釈**: MCPは比較的新しいプロトコルであり、仕様の解釈やクライアント実装との互換性に注意が必要となる可能性がある。
-   **状態管理の複雑性**: 複数のクライアントからのリクエストを同時に処理する場合、サーバー内の状態管理が複雑になる可能性がある。
-   **生成AI連携の精度**: 生成AIに提供する構造化テキストの形式によっては、AIが正確に情報を理解できない可能性がある。出力形式の最適化が必要となる。
-   **バリデーションの厳格さ**: バリデーションが厳格すぎると利用可能なモデルが少なくなり、柔軟性が失われる可能性がある。適切なバランス調整が必要。

## 10. 今後のステップ

1.  本計画書の内容についてユーザーレビューを受け、承認を得る。
2.  承認後、ファイル名を `WIP_add-mcp-server-feature.md` に変更し、実装タスクを開始する。
3.  実装とテストが完了したら、ユーザーに完了報告を行い、承認を得る。
4.  承認後、作業内容のサマリを追記し、ファイル名を `DONE_add-mcp-server-feature.md` に変更する。