# Excelバリデーション & JSON出力ツール 要件定義書

## 1. 概要

本ツールは、Excel上に存在する既存のフォーム（申請書等）に対して、柔軟なバリデーションとデータ抽出を行うことを目的としたものである。社内でよく使われている方眼紙形式のExcel申請書を対象に、ルールベースでの入力チェックと、後続処理に使えるJSON形式でのデータ出力を可能にする。

## 2. ユースケース

- ユーザーがExcelで作成された申請書を指定し、入力内容の妥当性を検証する。
- バリデーションルールに違反している箇所があれば、その内容を一覧表示する。
- 入力済みの値を指定フォーマットでJSONとして出力する。

## 3. 主な機能

### 3.1 入力

- Excelファイル（.xlsx）の読み込み
- 対象シート名、セル範囲などは設定ファイルで指定

### 3.2 バリデーション

- 単一セルの値検証（値の一致、不一致、数値範囲、正規表現マッチなど）
- 複数セル間の条件付きバリデーション（含意など）
- 複雑な条件の組み合わせにも対応可能
- 正規表現による文字列チェック（メールアドレス形式や形式自由記述欄の制限など）

### 3.3 出力

- エラー一覧の出力（ログ、ターミナル、GUI 等）
- JSON形式によるデータ出力

## 4. バリデーションルールの記述方式（DSL）

### 4.0 フィールド定義（セルマッピング）

ルールDSL内では、各セルに論理名を付与して参照する。これらの論理名は、実際のセル位置（例: A1形式）とマッピングされる必要がある。これにより、ルール記述とExcel上のセル位置が結び付けられる。

#### 例：
```yaml
fields:
  animal_select: B5
  animal_free_text: D5
  email: E5

rules:
  - name: "その他選択時の自由記入必須"
    expression:
      any_of:
        - compare:
            left: "animal_select"
            operator: "!="
            right: "その他"
        - field: "animal_free_text"
          required: true
    error_message: "「その他」を選んだ場合は内容を記入してください。"

  - name: "メール形式チェック"
    expression:
      regex_match:
        field: "email"
        pattern: "^[\\w\\.-]+@[\\w\\.-]+\\.\\w+$"
    error_message: "メールアドレスの形式が正しくありません。"
```

このように、`fields` セクションで論理名とセル位置のマッピングを定義することで、ルール記述を分かりやすく簡潔に保つ。

### 4.1 使用可能な式（expression node）

- `compare`: セル同士またはセルと値の比較
- `field + required`: 指定セルの入力必須
- `any_of`: 複数条件のうち少なくとも1つが成立
- `all_of`: すべての条件が成立
- `not`: 条件の否定
- `regex_match`: セルの値が指定の正規表現にマッチするかを検証
- `enum`: セルの値が指定された選択肢リストに含まれることを検証

> 含意（if A then B）などの複雑な条件も `any_of` と `not` を組み合わせることで表現可能

## 5. スキーマ設計

YAMLルールの構文はJSON Schemaで記述可能とし、エディタでの補完や静的検証を可能にする。

スキーマ定義の詳細は別ファイル（[`rule-schema.json`](./rule-schema.json)）として提供する。

### 5.1 スキーマファイル（rule-schema.json）の設計方針（要約）

- `expression` は構文木（AST）として表現し、構造ごとに分岐する厳密なスキーマとする。
- `compare`, `regex_match`, `required`, `any_of`, `all_of`, `not` などの型ごとに明示的に定義。
- `expression` ノードの分岐は `oneOf` を使って記述。

## 6. 実装方針

- Python + openpyxl or pandas によるExcel操作
- ルールエンジン部は再帰的な構文木として処理
- スキーマベースのルール検証支援

## 7. 今後の拡張案

- GUIによるルール定義支援
- シート上のセル座標と論理名のマッピング機能
- `imply` や `match`, `range` などの記法追加

## 8. 注意事項

- 含意のような条件は記法としては持たず、DSLの組み合わせによって表現する。
- YAML記述ルールのガイドラインを利用者向けに提供予定。
- `enum` ルールの実装においては、以下の点に注意する必要がある：
  - 値の比較時に型変換が必要な場合がある。
  - `case_sensitive` オプションを考慮し、大文字小文字の区別を適切に処理する。
  - 空文字や null 値の扱いについては、`required` ルールと組み合わせて検証する設計を推奨する。

---

以上。

