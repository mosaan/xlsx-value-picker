# systemPatterns.md

## システム構成・設計パターン

- 設定ファイル（YAML）→値取得ロジック→出力（JSON/YAML）というシンプルなパイプライン
- openpyxlのdata_onlyモードで計算後の値を取得
- コマンドライン引数で設定ファイル・出力ファイルを指定可能
- 拡張性を考慮し、出力フォーマット追加やエラー処理をモジュール化
- 設定ファイル（YAML）でシート名または`*N`（左からN番目のシート）指定が可能な柔軟な値取得パターンを採用
- main.pyのget_excel_values関数で`*N`記法を判定し、シートリストからインデックスで選択する実装
- シート名に`*`が使えないExcel仕様を活用し、記法の衝突を回避
- エラー処理：範囲外や不正な`*N`指定はValueErrorで明示的に例外化
- `*N`記法の自動テスト（test_main.py）でシート順指定の動作を検証

## テーブル・範囲指定による複数レコード抽出仕様

- 設定ファイル（YAML）でExcelテーブル名またはセル範囲を指定し、複数行・複数列のデータを抽出できる方式を採用。
- 出力JSONのキー名は、Excel上の列名または列位置番号と任意のキー名のマッピングで柔軟に指定可能。

### table指定方式
- `table`キーでExcelテーブル名（ListObject名）を指定。
- `columns`で「Excel列名: 出力キー名」のマッピングを記述。
- 例:
  ```yaml
  - table: Table1
    columns:
      Excel列名1: 出力キー1
      Excel列名2: 出力キー2
  ```

### range指定方式
- `range`キーでデータ部分のみのセル範囲（例: Sheet1!A2:D10）を指定（ヘッダ行は含めない）。
- `columns`で「左からの列位置番号（1始まり）: 出力キー名」のマッピングを記述。
- 例:
  ```yaml
  - range: Sheet1!A2:D10
    columns:
      1: keyA
      3: keyC
  ```
- 列位置番号は1始まりで統一。

### range指定の空行（全列None）スキップ仕様（2025/04/16追加）
- range指定でデータ範囲を抽出する際、各行の「すべての列がNone（空）」となる行はデフォルトで出力に含めずスキップする。
- コマンドラインオプション`--include-empty-range-row`を指定した場合のみ、全列がNoneの行も出力に含める。
- これにより、意図しない空行の混入を防ぎつつ、必要に応じて明示的に空行も取得できる柔軟な仕様となっている。
- 実装はextract_range_records関数・main.pyのCLI引数で制御され、テストもtest_main.pyで自動化されている。

## 主要コンポーネント
- main.py: エントリーポイント、全体の制御
- 設定ファイルパーサー
- Excel値取得モジュール
- 出力モジュール

## 重要な実装パス
- 設定ファイルのバリデーション
- Excelファイルの安全な読み込み
- 取得値の型変換・整形
